{% props
  class = '',
  disabled = null,
  invalid = false,
  size = 'md',
  variant = 'default',
  rounded = 'lg',
%}

{# Nested attributes for fine-grained customization #}
{% set beforeAttrs = attributes.nested('before') %}
{% set afterAttrs = attributes.nested('after') %}
{% set contentAttrs = attributes.nested('content') %}

{# Check for divide attribute on before/after #}
{% set divideBefore = beforeAttrs.all()['divide']|default(false) %}
{% set divideAfter = afterAttrs.all()['divide']|default(false) %}

{# Extended size configuration with addon sizing #}
{% set sizeConfig = {
  'sm': {
    text: 'text-xs',
    height: 'min-h-8',
    icon: 'size-4',
    beforePadding: 'pl-2.5',
    afterPadding: 'pr-2.5',
    dividerMargin: 'my-1.5'
  },
  'md': {
    text: 'text-sm',
    height: 'min-h-10',
    icon: 'size-5',
    beforePadding: 'pl-3',
    afterPadding: 'pr-3',
    dividerMargin: 'my-2'
  },
  'lg': {
    text: 'text-base',
    height: 'min-h-12',
    icon: 'size-6',
    beforePadding: 'pl-4',
    afterPadding: 'pr-4',
    dividerMargin: 'my-2.5'
  },
} %}

{% set variantConfig = {
  'default': 'bg-white dark:bg-gray-900 outline-gray-300 dark:outline-gray-700',
  'filled': 'bg-gray-100 dark:bg-gray-800 outline-transparent',
  'flushed': 'bg-transparent border-0 border-b-2 border-gray-300 dark:border-gray-700 rounded-none outline-none',
  'unstyled': 'bg-transparent border-0 outline-none',
} %}

{% set roundedConfig = {
  'none': 'rounded-none',
  'sm': 'rounded-sm',
  'md': 'rounded-md',
  'lg': 'rounded-lg',
  'xl': 'rounded-xl',
  'full': 'rounded-full',
} %}

{% set currentSize = sizeConfig[size] ?? sizeConfig['md'] %}
{% set currentVariant = variantConfig[variant] ?? variantConfig['default'] %}
{% set currentRounded = variant == 'flushed' ? '' : (roundedConfig[rounded] ?? roundedConfig['lg']) %}

{% set baseClasses = 'relative flex items-stretch w-full outline-1 -outline-offset-1 placeholder:text-gray-400 dark:placeholder:text-gray-600 focus-within:outline-2 focus-within:-outline-offset-2 text-gray-900 dark:text-gray-100 disabled:cursor-not-allowed disabled:bg-gray-50 dark:disabled:bg-gray-800 disabled:text-gray-500 dark:disabled:text-gray-500 disabled:outline-gray-200 dark:disabled:outline-gray-800' %}

{% set invalidClasses = invalid ? 'outline-red-500 dark:outline-red-500 focus-within:outline-red-500 dark:focus-within:outline-red-500' : 'focus-within:outline-primary dark:focus-within:outline-primary' %}

{% set class = (baseClasses ~ ' ' ~ invalidClasses ~ ' ' ~ currentSize.text ~ ' ' ~ currentSize.height ~ ' ' ~ currentVariant ~ ' ' ~ currentRounded ~ ' ' ~ class)|tailwind_merge %}

{# Capture block content to check if they're empty #}
{% set beforeBlock %}{% block before '' %}{% endset %}
{% set afterBlock %}{% block after '' %}{% endset %}

<div
  {{ attributes.without('before', 'after', 'content') }}
  {% if disabled %}disabled{% endif %}
  {% if invalid %}data-invalid="true"{% endif %}
  data-size="{{ size }}"
  data-variant="{{ variant }}"
  class="{{ class ?? '' }}"
>
  {# BEFORE SLOT #}
  {% if beforeBlock|trim is not empty %}
    <div
      class="{{ ('flex items-center shrink-0 ' ~ currentSize.beforePadding ~ ' ' ~ beforeAttrs.render('class'))|tailwind_merge }}"
      {{ beforeAttrs.without('class', 'divide') }}
    >
      {{ beforeBlock|raw }}
    </div>

    {# Divider after before slot #}
    {% if divideBefore %}
      <div class="flex items-center">
        <div class="h-1/2 w-px bg-gray-200 dark:bg-gray-700"></div>
      </div>
    {% endif %}
  {% endif %}

  {# CONTENT SLOT (main input area) #}
  <div
    class="{{ ('flex-1 min-w-0 flex items-center ' ~ contentAttrs.render('class'))|tailwind_merge }}"
    {{ contentAttrs.without('class') }}
  >
    {% block content '' %}
  </div>

  {# AFTER SLOT #}
  {% if afterBlock|trim is not empty %}
    {# Divider before after slot #}
    {% if divideAfter %}
      <div class="flex items-center">
        <div class="h-1/2 w-px bg-gray-200 dark:bg-gray-700"></div>
      </div>
    {% endif %}

    <div
      class="{{ ('flex items-center shrink-0 ' ~ currentSize.afterPadding ~ ' ' ~ afterAttrs.render('class'))|tailwind_merge }}"
      {{ afterAttrs.without('class', 'divide') }}
    >
      {{ afterBlock|raw }}
    </div>
  {% endif %}
</div>
