{% props
    active = null,
    href = null,
    label = null,
    icon = null,
    badge = null,
    badgeVariant = 'default',
    count = null,
    expanded = false,
    disabled = false,
    class = '',
%}

{% set childrenBlock %}{% block children '' %}{% endset %}
{% set haveChildren = childrenBlock is not empty %}
{% set rightBlock %}{% block right '' %}{% endset %}
{% set hasRightSlot = rightBlock is not empty or badge or count is not null %}

<div
    {{ attributes.without('class') }}
    data-cisse--ui-bundle--menu-target="item"
    data-active="{{ active ? 'true' : 'false' }}"
    data-action="mouseenter->cisse--ui-bundle--menu#showFlyout mouseenter->cisse--ui-bundle--menu#cancelHideFlyout mouseleave->cisse--ui-bundle--menu#scheduleHideFlyout"
    class="group/item w-full relative {{ attributes.render('class') }}"
>
    <a
        {% if haveChildren %}
            data-action="click->cisse--ui-bundle--menu#toggle"
        {% endif %}
        href="{{ haveChildren ? 'javascript:void(0)' : (href ?? '#') }}"
        class="group/link relative flex w-full items-center justify-center gap-2 py-2 px-3 rounded-lg transition-colors duration-200 {{ disabled ? 'opacity-50 pointer-events-none' : '' }} group-data-[collapsed=true]/sidebar:px-0"
        {% if disabled %}aria-disabled="true"{% endif %}
    >
        {% block content %}
            {# Icon #}
            {% set iconClass = ('transition-all duration-300 size-5 group-data-[collapsed=true]/sidebar:size-8 ' ~ (active ? 'text-white' : 'text-white/50 group-hover/link:text-white/80') ~ ' ' ~ attributes.nested('icon').render('class'))|tailwind_merge %}
            <div class="relative">
                <twig:ux:icon
                    name="{{ icon ?: 'heroicons:squares-2x2' }}"
                    class="{{ iconClass }}"
                />
            </div>

            {# Label - hidden when collapsed #}
            {% set labelClass = ('flex-1 text-left text-sm font-semibold whitespace-nowrap transition-colors group-data-[collapsed=true]/sidebar:hidden ' ~ (active ? 'text-white' : 'text-white/50 group-hover/link:text-white/80') ~ ' ' ~ attributes.nested('label').render('class'))|tailwind_merge %}
            <span class="{{ labelClass }}" {{ attributes.nested('label').without('class') }}>
                {% block label label|raw %}
            </span>

            {# Right slot: badge, count, or custom content #}
            {% if hasRightSlot and not haveChildren %}
                <span class="flex items-center gap-2 group-data-[collapsed=true]/sidebar:hidden">
                    {% if rightBlock is not empty %}
                        {{ rightBlock|raw }}
                    {% endif %}

                    {% if badge %}
                        <twig:ui:badge variant="{{ badgeVariant }}" size="sm">{{ badge }}</twig:ui:badge>
                    {% endif %}

                    {% if count is not null %}
                        <span class="text-xs font-medium {{ active ? 'text-white/80' : 'text-white/50' }}">
                            {{ count }}
                        </span>
                    {% endif %}
                </span>
            {% endif %}

            {# Chevron for expandable items #}
            {% if haveChildren %}
                <span class="flex items-center gap-2 group-data-[collapsed=true]/sidebar:hidden">
                    {% if badge %}
                        <twig:ui:badge variant="{{ badgeVariant }}" size="sm">{{ badge }}</twig:ui:badge>
                    {% endif %}

                    {% if count is not null %}
                        <span class="text-xs font-medium {{ active ? 'text-white/80' : 'text-white/50' }}">
                            {{ count }}
                        </span>
                    {% endif %}

                    <twig:ux:icon
                        name="lucide:chevron-right"
                        data-cisse--ui-bundle--menu-target="chevron"
                        data-open="{{ expanded ? 'true' : 'false' }}"
                        class="size-4 transition-transform duration-200 {{ expanded ? 'rotate-90' : 'rotate-0' }} {{ active ? 'text-white' : 'text-white/50 group-hover/link:text-white/80' }}"
                    />
                </span>
            {% endif %}
        {% endblock %}
    </a>

    {# Inline submenu (expanded sidebar) #}
    {% if haveChildren %}
        <twig:ui:menu:sub :expanded="expanded">
            {{ childrenBlock|raw }}
        </twig:ui:menu:sub>
    {% endif %}

    {# Flyout template for collapsed state - will be cloned to body by JS #}
    {% if haveChildren %}
        <div
            data-cisse--ui-bundle--menu-target="flyout"
            data-flyout
            class="group/flyout hidden min-w-48 rounded-lg border border-gray-200 bg-white py-2 shadow-lg dark:border-gray-700 dark:bg-gray-800"
        >
            {# Label header #}
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">
                {{ label }}
            </div>
            {# Children - rendered as flyout items #}
            <div class="flex flex-col" data-flyout-children>
                {{ childrenBlock|raw }}
            </div>
        </div>
    {% endif %}

    {# Tooltip for items without children when collapsed #}
    {% if not haveChildren %}
        <div
            data-cisse--ui-bundle--menu-target="flyout"
            class="hidden px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm shadow-lg whitespace-nowrap dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200"
        >
            {{ label }}
            {% if badge %}<span class="ml-2 text-xs text-gray-500 dark:text-gray-400">({{ badge }})</span>{% endif %}
            {% if count is not null %}<span class="ml-2 text-xs text-gray-500 dark:text-gray-400">({{ count }})</span>{% endif %}
        </div>
    {% endif %}
</div>
