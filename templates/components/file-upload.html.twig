{% props
  name = null,
  id = null,
  accept = null,
  multiple = false,
  maxSize = null,
  maxFiles = null,
  disabled = false,
  label = 'Drop files here or click to upload',
  description = null,
  size = 'md',
  variant = 'default',
  showIcon = true,
  showFileList = true,
  class = '',
%}

{# Nested attributes for fine-grained customization #}
{% set dropzoneAttrs = attributes.nested('dropzone') %}
{% set inputAttrs = attributes.nested('input') %}
{% set iconAttrs = attributes.nested('icon') %}
{% set labelAttrs = attributes.nested('label') %}
{% set descriptionAttrs = attributes.nested('description') %}
{% set fileListAttrs = attributes.nested('fileList') %}

{% set maxSizeFormatted = maxSize ? (maxSize >= 1048576 ? ((maxSize / 1048576)|number_format(1) ~ ' MB') : ((maxSize / 1024)|number_format(1) ~ ' KB')) : null %}

{% set sizeConfig = {
  'sm': { padding: 'p-4', icon: 'size-8', labelText: 'text-xs', descText: 'text-xs', gap: 'space-y-1' },
  'md': { padding: 'p-8', icon: 'size-12', labelText: 'text-sm', descText: 'text-xs', gap: 'space-y-2' },
  'lg': { padding: 'p-12', icon: 'size-16', labelText: 'text-base', descText: 'text-sm', gap: 'space-y-3' },
} %}

{% set variantConfig = {
  'default': 'border-2 border-dashed rounded-lg',
  'solid': 'border rounded-lg bg-gray-50 dark:bg-gray-800/50',
  'minimal': 'border border-dashed rounded',
} %}

{% set currentSize = sizeConfig[size] ?? sizeConfig['md'] %}
{% set currentVariant = variantConfig[variant] ?? variantConfig['default'] %}

<div
  {{ attributes }}
  data-controller="cisse--ui-bundle--file-upload"
  data-cisse--ui-bundle--file-upload-max-size-value="{{ maxSize ?? '' }}"
  data-cisse--ui-bundle--file-upload-max-files-value="{{ maxFiles ?? '' }}"
  data-cisse--ui-bundle--file-upload-accept-value="{{ accept ?? '' }}"
  data-size="{{ size }}"
  data-variant="{{ variant }}"
  class="{{ ('space-y-4 ' ~ class)|tailwind_merge }}"
>
  {# Dropzone #}
  <div
    data-cisse--ui-bundle--file-upload-target="dropzone"
    data-action="
      drop->cisse--ui-bundle--file-upload#drop
      dragover->cisse--ui-bundle--file-upload#dragover
      dragleave->cisse--ui-bundle--file-upload#dragleave
      click->cisse--ui-bundle--file-upload#click
    "
    class="{{ ('relative text-center transition-colors ' ~ currentVariant ~ ' ' ~ currentSize.padding ~ ' ' ~ (disabled ? 'border-gray-200 bg-gray-50 cursor-not-allowed dark:border-gray-700 dark:bg-gray-800' : 'cursor-pointer border-gray-300 hover:border-primary-400 hover:bg-gray-50 dark:border-gray-600 dark:hover:border-primary-500 dark:hover:bg-gray-800') ~ ' ' ~ dropzoneAttrs.render('class'))|tailwind_merge }}"
    {{ dropzoneAttrs.without('class') }}
  >
    <input
      data-cisse--ui-bundle--file-upload-target="input"
      type="file"
      class="{{ ('hidden ' ~ inputAttrs.render('class'))|tailwind_merge }}"
      {{ inputAttrs.without('class') }}
      {% if name %}name="{{ name }}{{ multiple ? '[]' : '' }}"{% endif %}
      {% if id %}id="{{ id }}"{% endif %}
      {% if accept %}accept="{{ accept }}"{% endif %}
      {{ multiple ? 'multiple' }}
      {{ disabled ? 'disabled' }}
      data-action="change->cisse--ui-bundle--file-upload#change"
    >

    <div class="{{ currentSize.gap }}">
      {% if showIcon %}
        <twig:ux:icon name="heroicons:cloud-arrow-up" class="{{ (currentSize.icon ~ ' mx-auto text-gray-400 ' ~ iconAttrs.render('class'))|tailwind_merge }}" {{ ...iconAttrs.without('class') }} data-cisse--ui-bundle--file-upload-target="icon" />
      {% endif %}
      <p class="{{ (currentSize.labelText ~ ' font-medium text-gray-700 dark:text-gray-300 ' ~ labelAttrs.render('class'))|tailwind_merge }}" {{ labelAttrs.without('class') }}>
        {{ label }}
      </p>
      {% if description %}
        <p class="{{ (currentSize.descText ~ ' text-gray-500 dark:text-gray-400 ' ~ descriptionAttrs.render('class'))|tailwind_merge }}" {{ descriptionAttrs.without('class') }}>
          {{ description }}
        </p>
      {% endif %}
      {% if maxSizeFormatted %}
        <p class="{{ currentSize.descText }} text-gray-500 dark:text-gray-400">
          Max size: {{ maxSizeFormatted }}
        </p>
      {% endif %}
    </div>
  </div>

  {# File list #}
  {% if showFileList %}
    <ul data-cisse--ui-bundle--file-upload-target="fileList" class="{{ ('space-y-2 hidden ' ~ fileListAttrs.render('class'))|tailwind_merge }}" {{ fileListAttrs.without('class') }}></ul>
  {% endif %}

  {# File item template #}
  <template data-cisse--ui-bundle--file-upload-target="template">
    <li class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <twig:ux:icon name="heroicons:document" data-file-icon class="size-8 text-gray-400" />

      <div class="flex-1 min-w-0">
        <p data-file-name class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate"></p>
        <p data-file-size class="text-xs text-gray-500 dark:text-gray-400"></p>
      </div>

      <button
        type="button"
        class="p-1 text-gray-400 hover:text-red-500 rounded"
        data-action="click->cisse--ui-bundle--file-upload#removeFile"
      >
        <twig:ux:icon name="heroicons:x-mark" class="size-5" />
      </button>
    </li>
  </template>
</div>
