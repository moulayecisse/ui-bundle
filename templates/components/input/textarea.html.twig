{% props
    class = '',
    value = '',
    rows = 3,
    form = null,
    name = null,
    id = null,
    label = null,
    placeholder = null,
    hint = null,
    error = null,
    required = false,
    autofocus = false,
    disabled = false,
    readonly = false,
    maxLength = null,
    showCount = false,
    resize = 'vertical',
    size = 'md',
%}

{# Nested attributes for fine-grained customization #}
{% set labelAttrs = attributes.nested('label') %}
{% set wrapperAttrs = attributes.nested('wrapper') %}
{% set textareaAttrs = attributes.nested('textarea') %}
{% set countAttrs = attributes.nested('count') %}
{% set hintAttrs = attributes.nested('hint') %}
{% set errorAttrs = attributes.nested('error') %}

{% if form %}
    {% set name = name ?? form.vars.full_name %}
    {% set id = id ?? form.vars.id %}
    {% set value = value ?? form.vars.value %}
    {% set required = required ?? form.vars.required %}
    {% set disabled = disabled ?? form.vars.disabled %}
{% endif %}

{% set _id = id ?? name %}

{# Resize classes #}
{% set resizeClasses = {
    'none': 'resize-none',
    'vertical': 'resize-y',
    'horizontal': 'resize-x',
    'both': 'resize',
} %}

{# Size classes #}
{% set sizeClasses = {
    'sm': 'text-xs px-2.5 py-1.5',
    'md': 'text-sm px-3 py-2',
    'lg': 'text-base px-4 py-2.5',
} %}

{% set hasError = error is not empty %}

{% set contentBlock %}{% block content value %}{% endset %}

<div {{ attributes }}>
    {# Label #}
    {% if label %}
        <twig:ui:label for="{{ _id }}" :error="hasError" class="{{ labelAttrs.render('class') }}" {{ ...labelAttrs.without('class') }}>
            {{ label }}
            {% if required %}<span class="text-red-500 ml-0.5">*</span>{% endif %}
        </twig:ui:label>
    {% endif %}

    {# TextArea #}
    <twig:ui:input-wrapper
        :disabled="disabled"
        :invalid="hasError"
        class="{{ ((label ? 'mt-2' : '') ~ ' ' ~ class ~ ' ' ~ wrapperAttrs.render('class'))|tailwind_merge }}"
        {{ ...wrapperAttrs.without('class') }}
    >
        <textarea
            class="{{ ('block w-full bg-transparent focus:outline-none ' ~ (sizeClasses[size] ?? sizeClasses['md']) ~ ' ' ~ (resizeClasses[resize] ?? resizeClasses['vertical']) ~ ' ' ~ textareaAttrs.render('class'))|tailwind_merge }}"
            {{ textareaAttrs.without('class') }}
            rows="{{ rows }}"
            {% if name %}name="{{ name }}"{% endif %}
            {% if _id %}id="{{ _id }}"{% endif %}
            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
            {% if maxLength %}maxlength="{{ maxLength }}"{% endif %}
            {{ required ? 'required' }}
            {{ autofocus ? 'autofocus' }}
            {{ disabled ? 'disabled' }}
            {{ readonly ? 'readonly' }}
        >{{ contentBlock|raw }}</textarea>
    </twig:ui:input-wrapper>

    {# Character count #}
    {% if showCount or maxLength %}
        <div class="{{ ('flex justify-end mt-1 ' ~ countAttrs.render('class'))|tailwind_merge }}" {{ countAttrs.without('class') }}>
            <span class="text-xs text-gray-400">
                <span data-textarea-count>{{ value|length }}</span>{% if maxLength %} / {{ maxLength }}{% endif %}
            </span>
        </div>
    {% endif %}

    {# Hint #}
    {% if hint and not hasError %}
        <p class="{{ ('mt-1 text-sm text-gray-500 dark:text-gray-400 ' ~ hintAttrs.render('class'))|tailwind_merge }}" {{ hintAttrs.without('class') }}>{{ hint }}</p>
    {% endif %}

    {# Error #}
    {% if hasError %}
        <p class="{{ ('mt-1 text-sm text-red-600 dark:text-red-400 ' ~ errorAttrs.render('class'))|tailwind_merge }}" {{ errorAttrs.without('class') }}>{{ error }}</p>
    {% endif %}
</div>
