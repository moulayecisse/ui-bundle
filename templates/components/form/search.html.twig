{% props
  class = '',
  form = null,
  name = null,
  method = null,
  action = null,
  size = 'md',
  variant = 'default',
  rounded = 'lg',
  disabled = null,
%}

{# Nested attributes for fine-grained customization #}
{% set wrapperAttrs = attributes.nested('wrapper') %}
{% set iconAttrs = attributes.nested('icon') %}
{% set inputAttrs = attributes.nested('input') %}
{% set submitAttrs = attributes.nested('submit') %}
{% set dividerAttrs = attributes.nested('divider') %}
{% set tokenAttrs = attributes.nested('token') %}

{# Extract nested values with defaults #}
{% set iconName = iconAttrs.render('name')|default('heroicons:magnifying-glass') %}
{% set inputName = inputAttrs.render('name') %}
{% set inputValue = inputAttrs.render('value') %}
{% set inputPlaceholder = inputAttrs.render('placeholder')|default('Search...') %}

{% set showSubmit = submitAttrs.has('show') %}
{% set submitLabel = submitAttrs.render('label')|default('Search') %}
{% set submitIcon = submitAttrs.render('icon') %}

{% set hideDivider = dividerAttrs.has('hide') %}

{% set tokenName = tokenAttrs.render('name') %}
{% set tokenValue = tokenAttrs.render('value') %}

{% if form %}
  {% set tokenName = tokenName ?? field_name(form._token) %}
  {% set tokenValue = tokenValue ?? field_value(form._token) %}
  {% for child in form.children %}
    {% if child.vars.name != '_token' %}
      {% set inputPlaceholder = inputPlaceholder ?? child.vars.attr.placeholder ?? 'Search...' %}
      {% set inputName = inputName ?? field_name(child) %}
      {% set inputValue = inputValue ?? field_value(child) %}
    {% endif %}
  {% endfor %}

  {% set method = method ?? form.vars.method %}
  {% set name = name ?? field_name(form) %}
  {% set disabled = disabled ?? form.vars.disabled %}
{% endif %}

{# Size configuration for icon and padding #}
{% set sizeConfig = {
  'sm': { icon: 'size-4', padding: 'px-2.5 py-1', button: 'px-3 py-1 text-xs' },
  'md': { icon: 'size-5', padding: 'px-3 py-1.5', button: 'px-4 py-1.5 text-sm' },
  'lg': { icon: 'size-6', padding: 'px-4 py-2', button: 'px-5 py-2 text-base' },
} %}

{% set currentSizeConfig = sizeConfig[size] ?? sizeConfig['md'] %}

<form
  {{ attributes.without('wrapper', 'icon', 'input', 'submit', 'divider', 'token') }}
  {% if action %}action="{{ action }}"{% endif %}
  {% if method %}method="{{ method }}"{% endif %}
  {% if name %}name="{{ name }}"{% endif %}
  class="{{ class }}"
>
  <twig:ui:input-wrapper
    :disabled="disabled"
    :size="size"
    :variant="variant"
    :rounded="rounded"
    :after:divide="showSubmit and not hideDivider"
    class="{{ wrapperAttrs.render('class') }}"
    before:class="pl-1"
    {{ ...wrapperAttrs.without('class') }}
  >
    {% block before %}
      <twig:ux:icon
        name="{{ iconName }}"
        class="{{ (currentSizeConfig.icon ~ ' text-gray-400 dark:text-gray-500 ' ~ iconAttrs.render('class'))|tailwind_merge }}"
      />
    {% endblock %}

    {% block content %}
      <!--suppress HtmlFormInputWithoutLabel -->
      <input
        type="search"
        class="{{ ('block w-full bg-transparent focus:outline-none ' ~ currentSizeConfig.padding ~ ' ' ~ inputAttrs.render('class'))|tailwind_merge }}"
        {{ inputAttrs.without('class', 'name', 'value', 'placeholder') }}
        {% if inputName %}name="{{ inputName }}"{% endif %}
        {% if inputValue is not null %}value="{{ inputValue }}"{% endif %}
        {% if inputPlaceholder %}placeholder="{{ inputPlaceholder }}"{% endif %}
        {{ disabled ? 'disabled' }}
      />
    {% endblock %}

    {% block after %}
      {% if showSubmit %}
        <button
          type="submit"
          class="{{ ('flex items-center gap-2 font-semibold text-gray-800 dark:text-gray-100 hover:text-primary dark:hover:text-primary transition-colors whitespace-nowrap ' ~ currentSizeConfig.button ~ ' ' ~ submitAttrs.render('class'))|tailwind_merge }}"
          {{ submitAttrs.without('class', 'show', 'label', 'icon') }}
          {{ disabled ? 'disabled' }}
        >
          {% if submitIcon %}
            <twig:ux:icon name="{{ submitIcon }}" class="{{ currentSizeConfig.icon }}" />
          {% endif %}
          {{ submitLabel }}
        </button>
      {% endif %}
    {% endblock %}
  </twig:ui:input-wrapper>

  {% if tokenName and tokenValue %}
    <input type="hidden" name="{{ tokenName }}" value="{{ tokenValue }}">
  {% endif %}
</form>
