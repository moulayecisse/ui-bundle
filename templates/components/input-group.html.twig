{% props
  form = null,
  type = null,
  name = null,
  label = null,
  placeholder = null,
  required = null,
  disabled = null,
  id = null,
  value = null,
  autofocus = false,
  autocomplete = null,
  options = null,

  layout = null,
  col = null,

  size = 'md',
  variant = 'default',
  rounded = 'lg',
  class = '',
%}

{# Nested attributes for fine-grained customization #}
{% set wrapperAttrs = attributes.nested('wrapper') %}
{% set labelAttrs = attributes.nested('label') %}
{% set inputAttrs = attributes.nested('input') %}
{% set helpAttrs = attributes.nested('help') %}
{% set errorAttrs = attributes.nested('error') %}

{# Extract nested values with defaults #}
{% set labelText = labelAttrs.render('text') ?? label %}
{% set labelCol = labelAttrs.render('col')|default(4) %}
{% set helpText = helpAttrs.render('text') %}
{% set errorText = errorAttrs.render('text') %}
{% set inputCol = inputAttrs.render('col')|default(8) %}

{# Form integration - extract values from Symfony form #}
{% if form %}
  {% set name = name ?? field_name(form) %}
  {% set id = id ?? form.vars.id %}
  {% set labelText = labelText ?? field_label(form) %}
  {% set helpText = helpText ?? form.vars.help %}
  {% set disabled = disabled ?? form.vars.disabled ?? false %}
  {% set value = value ?? field_value(form) %}
  {% set errorText = errorText ?? (form.vars.errors|length > 0 ? form.vars.errors|first.message : null) %}

  {# Type detection from block_prefixes #}
  {% if type is null %}
    {% if 'email' in form.vars.block_prefixes %}
      {% set type = 'email' %}
    {% elseif 'password' in form.vars.block_prefixes %}
      {% set type = 'password' %}
    {% elseif 'textarea' in form.vars.block_prefixes %}
      {% set type = 'textarea' %}
    {% elseif 'checkbox' in form.vars.block_prefixes %}
      {% set type = 'checkbox' %}
    {% elseif 'entity' in form.vars.block_prefixes or 'choice' in form.vars.block_prefixes %}
      {% set type = 'choice' %}
    {% elseif 'date' in form.vars.block_prefixes %}
      {% set type = 'date' %}
    {% elseif 'search' in form.vars.block_prefixes %}
      {% set type = 'search' %}
    {% elseif 'number' in form.vars.block_prefixes or 'integer' in form.vars.block_prefixes %}
      {% set type = 'number' %}
    {% elseif 'money' in form.vars.block_prefixes %}
      {% set type = 'money' %}
    {% elseif 'percent' in form.vars.block_prefixes %}
      {% set type = 'percent' %}
    {% elseif 'url' in form.vars.block_prefixes %}
      {% set type = 'url' %}
    {% elseif 'tel' in form.vars.block_prefixes %}
      {% set type = 'phone' %}
    {% else %}
      {% set type = 'text' %}
    {% endif %}
  {% endif %}
{% endif %}

{% set type = type ?? 'text' %}
{% set id = id ?? name %}
{% set hasError = errorText is not null and errorText != '' %}

{# Inherit layout from parent form if not explicitly set #}
{# Try multiple approaches to get parent layout #}
{% set inheritedLayout = outerScope._formLayout ?? outerScope.layout ?? null %}
{% set layout = layout ?? inheritedLayout ?? 'vertical' %}

{# Check if inline layout (flex context) #}
{% set isInline = layout == 'inline' %}

{# Column/sizing logic - different for grid vs flex contexts #}
{% set colClass = 'col-span-12' %}
{% set inlineStyle = '' %}
{% if isInline %}
  {% if col %}
    {% set percentage = (col / 12 * 100)|round(2) %}
    {% set colClass = 'shrink-0' %}
    {% set inlineStyle = 'flex-basis: ' ~ percentage ~ '%' %}
  {% else %}
    {% set colClass = 'flex-1 min-w-0' %}
  {% endif %}
{% else %}
  {% if col == 1 %}
    {% set colClass = colClass ~ ' sm:col-span-1' %}
  {% elseif col == 2 %}
    {% set colClass = colClass ~ ' sm:col-span-2' %}
  {% elseif col == 3 %}
    {% set colClass = colClass ~ ' sm:col-span-3' %}
  {% elseif col == 4 %}
    {% set colClass = colClass ~ ' sm:col-span-4' %}
  {% elseif col == 5 %}
    {% set colClass = colClass ~ ' sm:col-span-5' %}
  {% elseif col == 6 %}
    {% set colClass = colClass ~ ' sm:col-span-6' %}
  {% elseif col == 7 %}
    {% set colClass = colClass ~ ' sm:col-span-7' %}
  {% elseif col == 8 %}
    {% set colClass = colClass ~ ' sm:col-span-8' %}
  {% elseif col == 9 %}
    {% set colClass = colClass ~ ' sm:col-span-9' %}
  {% elseif col == 10 %}
    {% set colClass = colClass ~ ' sm:col-span-10' %}
  {% elseif col == 11 %}
    {% set colClass = colClass ~ ' sm:col-span-11' %}
  {% elseif col == 12 %}
    {% set colClass = colClass ~ ' sm:col-span-12' %}
  {% elseif type not in ['checkbox', 'hidden'] %}
    {% set colClass = colClass ~ ' sm:col-span-6' %}
  {% endif %}
{% endif %}

{# Input component parameters #}
{% set inputParams = {
  form,
  type,
  name,
  id,
  value,
  placeholder,
  required,
  disabled,
  autofocus: autofocus,
  autocomplete: autocomplete,
  size: size,
  variant: variant,
  rounded: rounded,
} %}

{% if type in ['choice'] and options is not null %}
  {% set inputParams = inputParams|merge({ choices: options }) %}
{% elseif form and type in ['choice'] %}
  {% set inputParams = inputParams|merge({ choices: form.vars.choices ?? [] }) %}
{% endif %}

{# Determine component name based on type #}
{% set componentName = 'Ui:input:text' %}
{% if type in ['checkbox', 'textarea', 'date', 'choice', 'money', 'percent', 'otp', 'search', 'email', 'password', 'url', 'phone', 'number', 'quantity'] %}
  {% set componentName = 'Ui:input:' ~ type %}
{% endif %}

{# Hidden fields render directly without wrapper #}
{% if type == 'hidden' %}
  <input type="hidden" name="{{ name }}" value="{{ value }}" />
{% elseif type == 'checkbox' %}
  {# Checkbox layout: input then label #}
  <div
    {{ attributes.without('wrapper', 'label', 'input', 'help', 'error') }}
    class="{{ (colClass ~ ' flex items-start gap-3 ' ~ class ~ ' ' ~ wrapperAttrs.render('class'))|tailwind_merge }}"
    {% if inlineStyle %}style="{{ inlineStyle }}"{% endif %}
    {{ wrapperAttrs.without('class') }}
  >
    {{ component(componentName, inputParams|merge({ attributes: inputAttrs.without('col') })) }}

    <div class="flex flex-col">
      {% if labelText %}
        <twig:ui:label
          :for="id"
          :required="required"
          class="{{ ('cursor-pointer ' ~ labelAttrs.render('class'))|tailwind_merge }}"
          {{ ...labelAttrs.without('class', 'text', 'col') }}
        >
          {{ labelText }}
        </twig:ui:label>
      {% endif %}

      {% if helpText and not hasError %}
        <p class="{{ ('text-sm text-gray-500 dark:text-gray-400 ' ~ helpAttrs.render('class'))|tailwind_merge }}" {{ helpAttrs.without('class', 'text') }}>
          {{ helpText }}
        </p>
      {% endif %}

      {% if hasError %}
        <p class="{{ ('text-sm text-red-600 dark:text-red-400 ' ~ errorAttrs.render('class'))|tailwind_merge }}" {{ errorAttrs.without('class', 'text') }}>
          {{ errorText }}
        </p>
      {% endif %}
    </div>
  </div>
{% elseif layout == 'horizontal' %}
  {# Horizontal layout: label left, input right #}
  {% if labelCol == 1 %}
    {% set labelColClass = 'col-span-12 sm:col-span-1' %}
  {% elseif labelCol == 2 %}
    {% set labelColClass = 'col-span-12 sm:col-span-2' %}
  {% elseif labelCol == 3 %}
    {% set labelColClass = 'col-span-12 sm:col-span-3' %}
  {% elseif labelCol == 4 %}
    {% set labelColClass = 'col-span-12 sm:col-span-4' %}
  {% elseif labelCol == 5 %}
    {% set labelColClass = 'col-span-12 sm:col-span-5' %}
  {% elseif labelCol == 6 %}
    {% set labelColClass = 'col-span-12 sm:col-span-6' %}
  {% else %}
    {% set labelColClass = 'col-span-12 sm:col-span-4' %}
  {% endif %}
  {% if inputCol == 6 %}
    {% set inputColClass = 'col-span-12 sm:col-span-6' %}
  {% elseif inputCol == 7 %}
    {% set inputColClass = 'col-span-12 sm:col-span-7' %}
  {% elseif inputCol == 8 %}
    {% set inputColClass = 'col-span-12 sm:col-span-8' %}
  {% elseif inputCol == 9 %}
    {% set inputColClass = 'col-span-12 sm:col-span-9' %}
  {% elseif inputCol == 10 %}
    {% set inputColClass = 'col-span-12 sm:col-span-10' %}
  {% elseif inputCol == 11 %}
    {% set inputColClass = 'col-span-12 sm:col-span-11' %}
  {% elseif inputCol == 12 %}
    {% set inputColClass = 'col-span-12 sm:col-span-12' %}
  {% else %}
    {% set inputColClass = 'col-span-12 sm:col-span-8' %}
  {% endif %}
  <div
    {{ attributes.without('wrapper', 'label', 'input', 'help', 'error') }}
    class="{{ (colClass ~ ' grid grid-cols-12 gap-4 items-start ' ~ class ~ ' ' ~ wrapperAttrs.render('class'))|tailwind_merge }}"
    {% if inlineStyle %}style="{{ inlineStyle }}"{% endif %}
    {{ wrapperAttrs.without('class') }}
  >
    {% if labelText %}
      <twig:ui:label
        :for="id"
        :required="required"
        class="{{ (labelColClass ~ ' sm:pt-2 sm:text-right ' ~ labelAttrs.render('class'))|tailwind_merge }}"
        {{ ...labelAttrs.without('class', 'text', 'col') }}
      >
        {{ labelText }}
      </twig:ui:label>
    {% endif %}

    <div class="{{ inputColClass }}">
      {{ component(componentName, inputParams|merge({ attributes: inputAttrs.without('col') })) }}

      {% if helpText and not hasError %}
        <p class="{{ ('mt-1 text-sm text-gray-500 dark:text-gray-400 ' ~ helpAttrs.render('class'))|tailwind_merge }}" {{ helpAttrs.without('class', 'text') }}>
          {{ helpText }}
        </p>
      {% endif %}

      {% if hasError %}
        <p class="{{ ('mt-1 text-sm text-red-600 dark:text-red-400 ' ~ errorAttrs.render('class'))|tailwind_merge }}" {{ errorAttrs.without('class', 'text') }}>
          {{ errorText }}
        </p>
      {% endif %}
    </div>
  </div>
{% else %}
  {# Vertical layout (default): label above, input below #}
  <div
    {{ attributes.without('wrapper', 'label', 'input', 'help', 'error') }}
    class="{{ (colClass ~ ' ' ~ class ~ ' ' ~ wrapperAttrs.render('class'))|tailwind_merge }}"
    {% if inlineStyle %}style="{{ inlineStyle }}"{% endif %}
    {{ wrapperAttrs.without('class') }}
  >
    {% if labelText %}
      <twig:ui:label
        :for="id"
        :required="required"
        class="{{ labelAttrs.render('class') }}"
        {{ ...labelAttrs.without('class', 'text', 'col') }}
      >
        {{ labelText }}
      </twig:ui:label>
    {% endif %}

    <div class="{{ labelText ? 'mt-2' : '' }}">
      {{ component(componentName, inputParams|merge({ attributes: inputAttrs.without('col') })) }}
    </div>

    {% if helpText and not hasError %}
      <p class="{{ ('mt-1 text-sm text-gray-500 dark:text-gray-400 ' ~ helpAttrs.render('class'))|tailwind_merge }}" {{ helpAttrs.without('class', 'text') }}>
        {{ helpText }}
      </p>
    {% endif %}

    {% if hasError %}
      <p class="{{ ('mt-1 text-sm text-red-600 dark:text-red-400 ' ~ errorAttrs.render('class'))|tailwind_merge }}" {{ errorAttrs.without('class', 'text') }}>
        {{ errorText }}
      </p>
    {% endif %}
  </div>
{% endif %}
